server {
    listen 80;
    server_name thomasche.top;

    location / {
        proxy_pass http://localhost:3000; # PM2 / Node 服务监听
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }

    # 处理 .next 静态资源
    location ~ ^/_next/ {
        proxy_pass http://localhost:3000;
        proxy_cache_valid 200 1h;
        access_log off;
    }

    # 处理 public 中的静态资源（如 favicon、图片等）
    location ~ ^/public/ {
        root /app/deploy/standalone;  # 或你部署的真实路径
        access_log off;
        expires 30d;
    }

    # Gzip 启用建议
    gzip on;
    gzip_static on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types
        text/plain
        text/css
        application/json
        application/javascript
        application/x-javascript
        text/xml
        application/xml
        application/xml+rss
        image/svg+xml
        font/woff2
        font/woff;

    # 安全响应头
    add_header X-Frame-Options "SAMEORIGIN";
    add_header X-Content-Type-Options "nosniff";
    add_header Referrer-Policy "strict-origin-when-cross-origin";

    # 缓存静态资源（来自 .next/static 和 public）
    location ~* \.(?:js|css|woff2?|ttf|svg|eot|ico|jpg|jpeg|png|webp|gif)$ {
        access_log off;
        expires 30d;
        add_header Cache-Control "public";
    }
}
